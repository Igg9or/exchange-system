<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Управление пользователями</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6">Пользователи</h1>

  <!-- Таблица пользователей -->
  <table class="w-full border-collapse bg-white shadow rounded mb-6">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-2 border">ID</th>
        <th class="p-2 border">Логин</th>
        <th class="p-2 border">Роль</th>
        <th class="p-2 border">Сервис</th>
        <th class="p-2 border">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr class="hover:bg-gray-50">
        <td class="p-2 border">{{ u.id }}</td>
        <td class="p-2 border">{{ u.login }}</td>
        <td class="p-2 border">{{ u.role }}</td>
        <td class="p-2 border">{{ u.service.name if u.service else '-' }}</td>
        <td class="p-2 border flex gap-2">
          <button onclick="openEditModal({{ u.id }}, '{{ u.login }}', '{{ u.role }}', '{{ u.service_id or '' }}')" 
                  class="bg-blue-500 text-white px-3 py-1 rounded">
            Редактировать
          </button>
          <form action="{{ url_for('delete_user', user_id=u.id) }}" method="post" onsubmit="return confirm('Удалить пользователя?')">
            <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded">Удалить</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Добавить пользователя -->
  <h2 class="text-xl font-semibold mb-4">Добавить пользователя</h2>
  <form action="{{ url_for('add_user') }}" method="post" class="bg-white p-4 rounded shadow space-y-3 w-96">
    <div>
      <label class="block text-sm font-medium">Логин</label>
      <input type="text" name="login" required class="border px-2 py-1 rounded w-full">
    </div>

    <div>
      <label class="block text-sm font-medium">Пароль</label>
      <input type="password" name="password" required class="border px-2 py-1 rounded w-full">
    </div>

    <div>
      <label class="block text-sm font-medium">Роль</label>
      <select name="role" class="border px-2 py-1 rounded w-full">
        <option value="operator">Оператор</option>
        <option value="admin">Админ</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium">Сервис (для оператора)</label>
      <select name="service_id" class="border px-2 py-1 rounded w-full">
        <option value="">-</option>
        {% for s in services %}
          <option value="{{ s.id }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Добавить</button>
  </form>
</div>

<!-- Модальное окно -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white p-6 rounded shadow-lg w-96">
    <h2 class="text-xl font-bold mb-4">Редактировать пользователя</h2>

    <form id="editUserForm" method="post">
      <div class="mb-3">
        <label class="block text-sm font-medium">Логин</label>
        <input type="text" id="editLogin" disabled class="border px-2 py-1 rounded w-full">
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Роль</label>
        <select name="role" id="editRole" class="border px-2 py-1 rounded w-full">
          <option value="operator">Оператор</option>
          <option value="admin">Админ</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Сервис</label>
        <select name="service_id" id="editService" class="border px-2 py-1 rounded w-full">
          <option value="">-</option>
          {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium">Новый пароль</label>
        <input type="password" name="password" class="border px-2 py-1 rounded w-full">
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Отмена</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openEditModal(id, login, role, serviceId) {
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editLogin').value = login;
    document.getElementById('editRole').value = role;
    document.getElementById('editService').value = serviceId || '';

    document.getElementById('editUserForm').action = "/users/edit/" + id;
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
  }
</script>

</body>
</html>
    