<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –ê–¥–º–∏–Ω</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  .card {
    border-radius: 1rem;
  }
  .table thead th {
    background-color: #f8f9fa !important;
    font-weight: 600;
  }
  .table-hover tbody tr:hover {
    background-color: #f3f6f9;
    transition: background-color 0.2s ease;
  }
  .card-title span {
    font-size: 1.2rem;
  }
</style>


</head>
<body class="bg-light">

<div class="container py-4">
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary mb-3">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <h2 class="mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–º–µ–Ω–∞–º</h2>

  <form method="get" action="{{ url_for('admin_analytics') }}" class="mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label>–°–µ—Ä–≤–∏—Å:</label>
        <select name="service_id" class="form-select" onchange="this.form.submit()">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          {% for s in services %}
            <option value="{{ s.id }}" {% if s.id == selected_service_id %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label>–î–∞—Ç–∞:</label>
        <input type="date" name="date" value="{{ selected_date or '' }}" class="form-control" onchange="this.form.submit()">
      </div>

      {% if shifts %}
      <div class="col-md-4">
        <label>–°–º–µ–Ω–∞:</label>
        <select name="shift_id" class="form-select" onchange="this.form.submit()">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          {% for sh in shifts %}
            <option value="{{ sh.id }}" {% if selected_shift and sh.id == selected_shift.id %}selected{% endif %}>
                –°–º–µ–Ω–∞ {{ sh.number }} ‚Äî {{ sh.start_time|to_moscow }}
                {% if sh.end_time %}- {{ sh.end_time|to_moscow }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
    </div>
  </form>

  {% if selected_shift %}
  <!-- üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ -->

  <!-- üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <span class="me-2">üìÖ</span>–°–º–µ–Ω–∞ #{{ selected_shift.number or selected_shift.id }}
    </h5>

    <div class="row text-muted small mb-2">
      <div class="col-md-4">
        <strong>–ù–∞—á–∞–ª–æ:</strong> {{ selected_shift.start_time|to_moscow }}
      </div>
      <div class="col-md-4">
        <strong>–ö–æ–Ω–µ—Ü:</strong> {{ selected_shift.end_time|to_moscow if selected_shift.end_time else '‚Äî' }}
      </div>
      <div class="col-md-4">
        <strong>–†–∞–±–æ—Ç–∞–ª–∏:</strong>
        {% if operators %}
          {{ operators|join(', ') }}
        {% else %}
          ‚Äî
        {% endif %}
      </div>
    </div>

    <hr>

    <div class="row text-center fw-semibold">
      <div class="col-md-4">
        üí∞ –ü—Ä–∏–±—ã–ª—å:
        <span class="text-success">{{ totals.profit|default(0)|format_number }} ‚ÇΩ</span>
      </div>
      <div class="col-md-4">
        ‚¨ÜÔ∏è –í–≤–æ–¥—ã:
        <span class="text-primary">{{ totals.inputs|default(0)|format_number }} ‚ÇΩ</span>
      </div>
      <div class="col-md-4">
        ‚¨áÔ∏è –í—ã–≤–æ–¥—ã:
        <span class="text-danger">{{ totals.outputs|default(0)|format_number }} ‚ÇΩ</span>
      </div>
    </div>
  </div>
</div>


 <div class="card shadow-sm border-0">
    <div class="card-body">
     <h6 class="card-title mb-3">üìã –ó–∞—è–≤–∫–∏ —ç—Ç–æ–π —Å–º–µ–Ω—ã</h6>
<div class="table-responsive">
  <table class="table table-hover align-middle table-sm">
    <thead class="table-light text-center">
      <tr>
        <th>ID</th>
        <th>–í—Ä–µ–º—è</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
        <th>–ü–æ–ª—É—á–∏–ª–∏</th>
        <th>–û—Ç–¥–∞–ª–∏</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–ü—Ä–∏–±—ã–ª—å (%)</th>
        <th>–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr
        class="
          {% if o.is_deleted %}table-danger text-decoration-line-through
          {% elif o.type == 'admin_io' or o.type == 'admin_action' %}table-secondary
          {% elif o.type == 'internal_transfer' %}table-info
          {% endif %}
        "
      >
        <td class="text-center">{{ o.id }}</td>
        <td>{{ o.created_at|to_moscow }}</td>
        <td>{{ o.category.name if o.category else '-' }}</td>
        <td>{{ o.user.login if o.user else '-' }}</td>
        <td class="text-success">
          {{ o.received_amount|trim_float }}
          {{ o.received_asset.symbol if o.received_asset else '' }}
        </td>
        <td class="text-danger">
          {{ o.given_amount|trim_float }}
          {{ o.given_asset.symbol if o.given_asset else '' }}
        </td>
        <td>{{ o.comment or '‚Äî' }}</td>
        <td>{{ "%.2f"|format(o.profit_percent or 0) }} %</td>
        <td class="text-end {% if o.profit_rub < 0 %}text-danger{% else %}text-success{% endif %}">
          {{ "%.2f"|format(o.profit_rub or 0) }} ‚ÇΩ
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


    </div>
  </div>
{% endif %}

  
</div>


<!-- üìä –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –°–ú–ï–ù–ê–ú -->
{% if selected_service_id %}
<hr class="mt-5 mb-4">
<h4>üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏ –ø–æ —Å–º–µ–Ω–∞–º</h4>

<!-- üîπ –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø–µ—Ä–∏–æ–¥—É -->
<div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-3">
  <div class="btn-group" role="group" aria-label="–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞">
    <button class="btn btn-outline-primary active" id="filterAll">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</button>
    <button class="btn btn-outline-primary" id="filterMonth">–ó–∞ –º–µ—Å—è—Ü</button>
    <button class="btn btn-outline-primary" id="filterWeek">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
  </div>

  <div class="d-flex align-items-center gap-2">
    <label class="form-label mb-0 fw-semibold">–ü–µ—Ä–∏–æ–¥:</label>
    <input type="date" id="dateFrom" class="form-control form-control-sm" style="width: 150px;">
    <span>‚Äî</span>
    <input type="date" id="dateTo" class="form-control form-control-sm" style="width: 150px;">
    <button class="btn btn-sm btn-primary" id="applyDates">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- üìä –ì–†–ê–§–ò–ö + –ò–¢–û–ì–ò -->
<div class="d-flex flex-wrap justify-content-between align-items-start mt-3" style="gap: 1rem;">
  <!-- üìà –ì—Ä–∞—Ñ–∏–∫ -->
  <div style="flex: 1; min-width: 600px; position: relative; height: 320px;">
    <canvas id="profitChart"></canvas>
  </div>

  <div class="mt-2">
  <button class="btn btn-sm btn-outline-secondary" id="resetZoom">–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±</button>
</div>

  <!-- üí∞ –ò—Ç–æ–≥–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
  <div class="card shadow-sm" style="min-width: 260px; flex-shrink: 0;">
    <div class="card-body">
      <h6 class="card-title mb-3">–ò—Ç–æ–≥–∏ –ø–µ—Ä–∏–æ–¥–∞</h6>
      <div class="d-flex flex-column gap-2">
        <div><strong>üí∏ –ü—Ä–∏–±—ã–ª—å:</strong> <span id="totalProfit">0 ‚ÇΩ</span></div>
        <div><strong>‚¨ÜÔ∏è –í–≤–æ–¥—ã:</strong> <span id="totalInputs">0 ‚ÇΩ</span></div>
        <div><strong>‚¨áÔ∏è –í—ã–≤–æ–¥—ã:</strong> <span id="totalOutputs">0 ‚ÇΩ</span></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const labelsAll = {{ chart_data.labels|tojson }};
  const profitsAll = {{ chart_data.profits|tojson }};
  const ctx = document.getElementById("profitChart").getContext("2d");
  const inputsAll = {{ chart_data.inputs|tojson }};
    const outputsAll = {{ chart_data.outputs|tojson }};
    const shiftIds = {{ chart_data.shift_ids|tojson }};
    

  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, "rgba(75,192,192,0.4)");
  gradient.addColorStop(1, "rgba(75,192,192,0)");

  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labelsAll,
      datasets: [{
        label: "–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)",
        data: profitsAll,
        fill: true,
        backgroundColor: gradient,
        borderColor: "rgba(75,192,192,1)",
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 3,
        pointHoverRadius: 8,
        shadowColor: "rgba(0,0,0,0.1)",
        shadowBlur: 6
        }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
            callbacks: {
            label: ctx => `–ü—Ä–∏–±—ã–ª—å: ${ctx.parsed.y.toLocaleString()} ‚ÇΩ`
            }
        },
        zoom: {
            zoom: {
                wheel: {
                enabled: true,
                speed: 0.05,
                },
                pinch: { enabled: true },
                mode: 'x',
                animation: {
                duration: 400,
                easing: 'easeOutCubic'
                },
                onZoom: ({chart}) => {
                adjustYAxis(chart);
                },
                onZoomComplete: ({chart}) => {
                adjustYAxis(chart);
                }
            },
            pan: {
                enabled: true,
                mode: 'x',
                animation: {
                duration: 300,
                easing: 'easeOutQuad'
                },
                onPan: ({chart}) => {
                adjustYAxis(chart);
                }
            },
            limits: {
                x: { min: 'original', max: 'original' },
                y: { min: 'original', max: 'original' }
            }
            }
        },
      animation: { duration: 1000, easing: "easeOutQuart" }
    }
  });

  // === üñ± –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–º–µ–Ω—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —Ç–æ—á–∫–µ ===
// === üñ± –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–º–µ–Ω–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ç–æ—á–∫—É ===
ctx.canvas.onclick = function(evt) {
  const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
  if (points.length) {
    const index = points[0].index;
    const shiftId = shiftIds[index]; // ‚úÖ –±–µ—Ä—ë–º ID —Å–º–µ–Ω—ã
    const params = new URLSearchParams(window.location.search);
    const serviceId = params.get("service_id");
    if (!serviceId || !shiftId) return;

    // –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —ç—Ç–æ–π —Å–º–µ–Ω—ã
    window.location.href = `/admin/analytics?service_id=${serviceId}&shift_id=${shiftId}`;
  }
};


  // --- –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º–∞—Å—à—Ç–∞–± ---
  function rescaleYAxis(data) {
    if (!data || data.length === 0) return;
    const sorted = [...data].sort((a, b) => a - b);
    const q1 = sorted[Math.floor(sorted.length * 0.25)];
    const q3 = sorted[Math.floor(sorted.length * 0.75)];
    const iqr = q3 - q1;
    const min = Math.max(Math.min(...data), q1 - 1.5 * iqr);
    const max = Math.min(Math.max(...data), q3 + 1.5 * iqr);
    const padding = (max - min) * 0.1;
    chart.options.scales.y.min = min - padding;
    chart.options.scales.y.max = max + padding;
  }

  // --- —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥—É ---
  function filterData(days) {
  const now = new Date();
  const filteredLabels = [];
  const filteredProfits = [];
  const filteredInputs = [];
  const filteredOutputs = [];

  for (let i = 0; i < labelsAll.length; i++) {
    const [day, month, year] = labelsAll[i].split(".");
    const date = new Date(`${year}-${month}-${day}`);
    const diffDays = (now - date) / (1000 * 60 * 60 * 24);
    if (days === 0 || diffDays <= days) {
      filteredLabels.push(labelsAll[i]);
      filteredProfits.push(profitsAll[i]);
      filteredInputs.push(inputsAll[i]);
      filteredOutputs.push(outputsAll[i]);
    }
  }

  chart.data.labels = filteredLabels;
  chart.data.datasets[0].data = filteredProfits;

  // üí∞ –ò—Ç–æ–≥–∏ –ø–µ—Ä–∏–æ–¥–∞
  const totalProfit = filteredProfits.reduce((a, b) => a + b, 0);
  const totalInputs = filteredInputs.reduce((a, b) => a + b, 0);
  const totalOutputs = filteredOutputs.reduce((a, b) => a + b, 0);

  document.getElementById("totalProfit").textContent = totalProfit.toLocaleString() + " ‚ÇΩ";
  document.getElementById("totalInputs").textContent = totalInputs.toLocaleString() + " ‚ÇΩ";
  document.getElementById("totalOutputs").textContent = totalOutputs.toLocaleString() + " ‚ÇΩ";

  rescaleYAxis(filteredProfits);
  chart.update();
}

  // --- –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ ---
  function setActive(id) {
    document.querySelectorAll(".btn-group .btn").forEach(btn => btn.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  document.getElementById("filterAll").addEventListener("click", () => { setActive("filterAll"); filterData(0); });
  document.getElementById("filterMonth").addEventListener("click", () => { setActive("filterMonth"); filterData(30); });
  document.getElementById("filterWeek").addEventListener("click", () => { setActive("filterWeek"); filterData(7); });
  document.getElementById("applyDates").addEventListener("click", () => {
  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;

  if (!from || !to) return;

  const dateFrom = new Date(from);
  const dateTo = new Date(to);

  const filteredLabels = [];
  const filteredData = [];

  for (let i = 0; i < labelsAll.length; i++) {
    const [day, month, year] = labelsAll[i].split(".");
    const date = new Date(`${year}-${month}-${day}`);
    if (date >= dateFrom && date <= dateTo) {
      filteredLabels.push(labelsAll[i]);
      filteredData.push(profitsAll[i]);
    }
  }

  chart.data.labels = filteredLabels;
  chart.data.datasets[0].data = filteredData;
  const totalProfit = filteredData.reduce((a, b) => a + b, 0);
  document.getElementById("totalProfit").textContent = totalProfit.toLocaleString() + " ‚ÇΩ";
  rescaleYAxis(filteredData);
  chart.update();
});

  // --- —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  filterData(0);


// --- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ ---
setTimeout(() => {
  chart.resetZoom();
  setTimeout(() => chart.resetZoom(), 300); // –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ ‚Äî –∫–∞–∫ —É —Ç–µ–±—è –≤—Ä—É—á–Ω—É—é
}, 200);

// --- –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ ---
document.getElementById("resetZoom").addEventListener("click", () => {
  chart.resetZoom();
});

function adjustYAxis(chart) {
  const data = chart.data.datasets[0].data;
  if (!data || !data.length) return;

  const visibleRange = chart.scales.x;
  const startIndex = Math.floor(visibleRange.min);
  const endIndex = Math.ceil(visibleRange.max);

  const visibleData = data.slice(startIndex, endIndex + 1);
  if (!visibleData.length) return;

  const min = Math.min(...visibleData);
  const max = Math.max(...visibleData);
  const padding = (max - min) * 0.15;

  chart.options.scales.y.min = min - padding;
  chart.options.scales.y.max = max + padding;
  chart.update('none'); // –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª–æ
}



});
</script>
{% endif %}




</body>
</html>
