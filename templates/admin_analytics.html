<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –ê–¥–º–∏–Ω</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary mb-3">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <h2 class="mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–º–µ–Ω–∞–º</h2>

  <form method="get" action="{{ url_for('admin_analytics') }}" class="mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label>–°–µ—Ä–≤–∏—Å:</label>
        <select name="service_id" class="form-select" onchange="this.form.submit()">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          {% for s in services %}
            <option value="{{ s.id }}" {% if s.id == selected_service_id %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label>–î–∞—Ç–∞:</label>
        <input type="date" name="date" value="{{ selected_date or '' }}" class="form-control" onchange="this.form.submit()">
      </div>

      {% if shifts %}
      <div class="col-md-4">
        <label>–°–º–µ–Ω–∞:</label>
        <select name="shift_id" class="form-select" onchange="this.form.submit()">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          {% for sh in shifts %}
            <option value="{{ sh.id }}" {% if selected_shift and sh.id == selected_shift.id %}selected{% endif %}>
                –°–º–µ–Ω–∞ {{ sh.number }} ‚Äî {{ sh.start_time|to_moscow }}
                {% if sh.end_time %}- {{ sh.end_time|to_moscow }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
    </div>
  </form>

  {% if selected_shift %}
    <div class="card mb-4 p-3">
      <h4>üìÖ –°–º–µ–Ω–∞ #{{ selected_shift.number or selected_shift.id }}</h4>
      <p>
    –ù–∞—á–∞–ª–æ: {{ selected_shift.start_time|to_moscow }}<br>
    –ö–æ–Ω–µ—Ü: {{ selected_shift.end_time|to_moscow if selected_shift.end_time else '‚Äî' }}<br>
    {% if operators %}
        –†–∞–±–æ—Ç–∞–ª–∏: {{ operators|join(', ') }}
    {% else %}
        –†–∞–±–æ—Ç–∞–ª–∏: ‚Äî
    {% endif %}
    </p>

      <ul>
        <li><strong>–ü—Ä–∏–±—ã–ª—å:</strong> {{ totals.profit|default(0)|format_number }} ‚ÇΩ</li>
        <li><strong>–í–≤–æ–¥—ã:</strong> {{ totals.inputs|default(0)|format_number }} ‚ÇΩ</li>
        <li><strong>–í—ã–≤–æ–¥—ã:</strong> {{ totals.outputs|default(0)|format_number }} ‚ÇΩ</li>
      </ul>
    </div>

    <h5>–ó–∞—è–≤–∫–∏ —ç—Ç–æ–π —Å–º–µ–Ω—ã</h5>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>ID</th>
          <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
          <th>–¢–∏–ø</th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th>–ü—Ä–∏–±—ã–ª—å ‚ÇΩ</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.user.login if o.user else '‚Äî' }}</td>
            <td>{{ o.type }}</td>
            <td>{{ o.comment }}</td>
            <td>{{ o.profit_rub|format_number }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  {% elif selected_service_id %}
    {% if shifts %}
      <h5>–°–º–µ–Ω—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É / —Å–µ—Ä–≤–∏—Å</h5>
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
            <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
            <th>–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          {% for sh in shifts %}
            <tr>
              <td>{{ sh.start_time|to_moscow }}</td>
              <td>{{ sh.user.login if sh.user else '‚Äî' }}</td>
              <td>{{ (sh.total_profit_rub or 0)|format_number }}</td>
              <td>
                <a href="{{ url_for('admin_analytics', service_id=selected_service_id, shift_id=sh.id) }}"
                   class="btn btn-sm btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>–ù–µ—Ç —Å–º–µ–Ω –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.</p>
    {% endif %}
  {% else %}
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.</p>
  {% endif %}
</div>

{% if selected_shift %}
  <div class="card p-3 mt-3">
    <h5>–°–º–µ–Ω–∞ #{{ selected_shift.number }}</h5>
    <p>
      –ù–∞—á–∞–ª–æ: {{ selected_shift.start_time|to_moscow }}<br>
      –ö–æ–Ω–µ—Ü: {{ selected_shift.end_time|to_moscow if selected_shift.end_time else '‚Äî' }}<br>
      {% if operators %}
        –†–∞–±–æ—Ç–∞–ª–∏: {{ operators|join(', ') }}
      {% else %}
        –†–∞–±–æ—Ç–∞–ª–∏: ‚Äî
      {% endif %}
    </p>

    <ul>
      <li><b>üí∞ –ü—Ä–∏–±—ã–ª—å:</b> {{ totals.profit|format_number }} ‚ÇΩ</li>
      <li><b>üí∏ –í–≤–æ–¥—ã:</b> {{ totals.inputs|format_number }} ‚ÇΩ</li>
      <li><b>üíµ –í—ã–≤–æ–¥—ã:</b> {{ totals.outputs|format_number }} ‚ÇΩ</li>
    </ul>
  </div>

  <h5 class="mt-4">–ó–∞—è–≤–∫–∏ —ç—Ç–æ–π —Å–º–µ–Ω—ã</h5>
  <table class="table table-sm table-striped">
    ...
  </table>
{% endif %}

<!-- üìä –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –°–ú–ï–ù–ê–ú -->
{% if selected_service_id %}
<hr class="mt-5 mb-4">
<h4>üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏ –ø–æ —Å–º–µ–Ω–∞–º</h4>

<!-- üîπ –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø–µ—Ä–∏–æ–¥—É -->
<div class="btn-group mb-3" role="group" aria-label="–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞">
  <button class="btn btn-outline-primary active" id="filterAll">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</button>
  <button class="btn btn-outline-primary" id="filterMonth">–ó–∞ –º–µ—Å—è—Ü</button>
  <button class="btn btn-outline-primary" id="filterWeek">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
</div>

<!-- üìä –ì–†–ê–§–ò–ö + –ò–¢–û–ì–ò -->
<div class="d-flex flex-wrap justify-content-between align-items-start mt-3" style="gap: 1rem;">
  <!-- üìà –ì—Ä–∞—Ñ–∏–∫ -->
  <div style="flex: 1; min-width: 600px; position: relative; height: 320px;">
    <canvas id="profitChart"></canvas>
  </div>

  <!-- üí∞ –ò—Ç–æ–≥–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
  <div class="card shadow-sm" style="min-width: 260px; flex-shrink: 0;">
    <div class="card-body">
      <h6 class="card-title mb-3">–ò—Ç–æ–≥–∏ –ø–µ—Ä–∏–æ–¥–∞</h6>
      <div class="d-flex flex-column gap-2">
        <div><strong>üí∏ –ü—Ä–∏–±—ã–ª—å:</strong> <span id="totalProfit">0 ‚ÇΩ</span></div>
        <div><strong>‚¨ÜÔ∏è –í–≤–æ–¥—ã:</strong> <span id="totalInputs">0 ‚ÇΩ</span></div>
        <div><strong>‚¨áÔ∏è –í—ã–≤–æ–¥—ã:</strong> <span id="totalOutputs">0 ‚ÇΩ</span></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const labelsAll = {{ chart_data.labels|tojson }};
  const profitsAll = {{ chart_data.profits|tojson }};
  const ctx = document.getElementById("profitChart").getContext("2d");

  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, "rgba(75,192,192,0.4)");
  gradient.addColorStop(1, "rgba(75,192,192,0)");

  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labelsAll,
      datasets: [{
        label: "–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)",
        data: profitsAll,
        fill: true,
        backgroundColor: gradient,
        borderColor: "rgba(75,192,192,1)",
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 3,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `–ü—Ä–∏–±—ã–ª—å: ${ctx.parsed.y.toLocaleString()} ‚ÇΩ`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: "#666", maxRotation: 50, minRotation: 50 },
          grid: { display: false }
        },
        y: {
          beginAtZero: false,
          ticks: {
            callback: v => v.toLocaleString() + " ‚ÇΩ",
            color: "#666"
          },
          grid: { color: "rgba(0,0,0,0.05)" }
        }
      },
      animation: { duration: 1000, easing: "easeOutQuart" }
    }
  });

  // --- üîπ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º–∞—Å—à—Ç–∞–± –ø–æ –º–µ–¥–∏–∞–Ω–µ ---
  function rescaleYAxis(data) {
    const sorted = [...data].sort((a, b) => a - b);
    const q1 = sorted[Math.floor(sorted.length * 0.25)];
    const q3 = sorted[Math.floor(sorted.length * 0.75)];
    const iqr = q3 - q1;
    const min = Math.max(Math.min(...data), q1 - 1.5 * iqr);
    const max = Math.min(Math.max(...data), q3 + 1.5 * iqr);
    chart.options.scales.y.min = min;
    chart.options.scales.y.max = max;
    // --- üí∞ –≤—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø–µ—Ä–∏–æ–¥–∞ ---
const totalProfit = filteredData.reduce((a, b) => a + b, 0);
const totalInputs = 0;  // üîπ –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –≤–≤–æ–¥—ã
const totalOutputs = 0;

document.getElementById("totalProfit").textContent = totalProfit.toLocaleString() + " ‚ÇΩ";
document.getElementById("totalInputs").textContent = totalInputs.toLocaleString() + " ‚ÇΩ";
document.getElementById("totalOutputs").textContent = totalOutputs.toLocaleString() + " ‚ÇΩ";

    chart.update();
  }

  // --- üîπ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ---
  function filterData(days) {
    const now = new Date();
    const filteredLabels = [];
    const filteredData = [];

    for (let i = 0; i < labelsAll.length; i++) {
      const dateParts = labelsAll[i].split(".");
      const date = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
      const diffDays = (now - date) / (1000 * 60 * 60 * 24);
      if (days === 0 || diffDays <= days) {
        filteredLabels.push(labelsAll[i]);
        filteredData.push(profitsAll[i]);
      }
    }

    chart.data.labels = filteredLabels;
    chart.data.datasets[0].data = filteredData;
    rescaleYAxis(filteredData);
    chart.update();
  }

  // --- –∫–Ω–æ–ø–∫–∏ ---
  document.getElementById("filterAll").addEventListener("click", () => {
    setActive("filterAll"); filterData(0);
  });
  document.getElementById("filterMonth").addEventListener("click", () => {
    setActive("filterMonth"); filterData(30);
  });
  document.getElementById("filterWeek").addEventListener("click", () => {
    setActive("filterWeek"); filterData(7);
  });

  function setActive(id) {
    document.querySelectorAll(".btn-group .btn").forEach(btn => btn.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  // —Å—Ç–∞—Ä—Ç
  rescaleYAxis(profitsAll);
});
</script>
{% endif %}




</body>
</html>
