<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Crypto Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<header class="bg-white shadow p-4 mb-6 flex justify-between items-center">
  <div>
    <span class="font-semibold">–ü—Ä–∏–≤–µ—Ç, {{ user.login }}</span>
    <span class="text-gray-500 text-sm"> ({{ user.role }})</span>
  </div>
  <div class="flex items-center gap-4">
    {% if user.role == "admin" %}
      <form method="get" action="{{ url_for('index') }}">
        <select name="service_id" onchange="this.form.submit()" class="border rounded px-2 py-1">
          {% for s in services %}
            <option value="{{ s.id }}" {% if service and service.id == s.id %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
      </form>
    {% else %}
      <span class="text-gray-600">–°–µ—Ä–≤–∏—Å: {{ service.name }}</span>
    {% endif %}
    {% if user.role == "admin" %}
  <a href="{{ url_for('users_list') }}" class="bg-blue-500 text-white px-3 py-1 rounded">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
{% endif %}
    <a href="{{ url_for('logout') }}" class="bg-red-500 text-white px-3 py-1 rounded">–í—ã–π—Ç–∏</a>
  </div>
</header>
  <div class="container mx-auto p-6">

    <h1 class="text-2xl font-bold mb-6">
      –°–µ—Ä–≤–∏—Å: {{ service.name if service else "–ù–µ—Ç —Å–µ—Ä–≤–∏—Å–∞" }}
    </h1>


    {% if user.role == "admin" %}
<h2 class="section-title mt-8">–ê–¥–º–∏–Ω—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h2>
<form action="{{ url_for('admin_action') }}" method="post" class="bg-white p-4 rounded shadow space-y-3">
  <div>
    <label class="block text-sm font-medium">–°–µ—Ä–≤–∏—Å</label>
    <select name="service_id" class="border px-2 py-1 rounded">
      {% for s in services %}
        <option value="{{ s.id }}">{{ s.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium">–ê–∫—Ç–∏–≤</label>
    <select name="asset_id" class="border px-2 py-1 rounded">
      {% for asset in assets %}
        <option value="{{ asset.id }}">{{ asset.symbol }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium">–û–ø–µ—Ä–∞—Ü–∏—è</label>
    <select name="action_type" class="border px-2 py-1 rounded">
      <option value="deposit">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</option>
      <option value="withdraw">–í—ã–≤–æ–¥</option>
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium">–°—É–º–º–∞</label>
    <input type="number" step="0.0001" name="amount" class="border px-2 py-1 rounded" required>
  </div>

  <div>
    <label class="block text-sm font-medium">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
  </div>

  <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
</form>
{% endif %}

    <!-- –ë–∞–ª–∞–Ω—Å—ã -->
    <h2 class="section-title mb-4">–ë–∞–ª–∞–Ω—Å—ã</h2>
<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
  {% for balance, asset in balances %}
  <div class="bg-white p-6 rounded-lg shadow flex items-center gap-4">
    <div class="w-12 h-12 flex items-center justify-center rounded-full 
                {% if asset.symbol == 'BTC' %} bg-yellow-100 text-yellow-600
                {% elif asset.symbol == 'ETH' %} bg-purple-100 text-purple-600
                {% elif asset.symbol == 'USDT' %} bg-green-100 text-green-600
                {% else %} bg-gray-100 text-gray-600 {% endif %}">
      <span class="text-xl font-bold">{{ asset.symbol[0] }}</span>
    </div>
    <div>
      <div class="text-lg font-semibold">{{ asset.symbol }}</div>
      <div class="text-gray-600">{{ "%.4f"|format(balance.amount) }}</div>
    </div>
  </div>
  {% endfor %}
</div>

<h2 class="section-title mt-8">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏</h2>
<form action="{{ url_for('internal_transfer') }}" method="post" class="bg-white p-4 rounded shadow space-y-3">
  <div>
  <label class="block text-sm font-medium">–û—Ç–∫—É–¥–∞ (—Å–µ—Ä–≤–∏—Å)</label>
  <select name="from_service_id" class="border px-2 py-1 rounded" {% if user.role == 'operator' %} disabled {% endif %}>
    {% for s in services %}
      <option value="{{ s.id }}" {% if user.role == 'operator' and s.id == service.id %} selected {% endif %}>
        {{ s.name }}
      </option>
    {% endfor %}
  </select>
  {% if user.role == 'operator' %}
    <input type="hidden" name="from_service_id" value="{{ service.id }}">
  {% endif %}
</div>

  <div>
  <label class="block text-sm font-medium">–ö—É–¥–∞ (—Å–µ—Ä–≤–∏—Å)</label>
  <select name="to_service_id" class="border px-2 py-1 rounded">
    {% for s in services %}
      <option value="{{ s.id }}">{{ s.name }}</option>
    {% endfor %}
  </select>
</div>

  <div>
    <label class="block text-sm font-medium">–ê–∫—Ç–∏–≤</label>
    <select name="asset_id" class="border px-2 py-1 rounded">
      {% for asset in assets %}
        <option value="{{ asset.id }}">{{ asset.symbol }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label class="block text-sm font-medium">–°—É–º–º–∞</label>
    <input type="number" step="0.0001" name="amount" class="border px-2 py-1 rounded" required>
  </div>

  <div>
    <label class="block text-sm font-medium">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
  </div>

  <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
</form>



    <div class="flex justify-between items-center mb-4">
  <h2 class="section-title">–ó–∞—è–≤–∫–∏</h2>
  <a href="{{ url_for('shift_report_html') }}" 
     class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
    üìä –û—Ç—á—ë—Ç –ø–æ —Å–º–µ–Ω–µ
  </a>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<form method="get" action="{{ url_for('index') }}" class="bg-white p-4 rounded shadow mb-4 flex flex-wrap gap-4 items-end">

  <!-- –¢–∏–ø –∑–∞—è–≤–∫–∏ -->
  <div>
    <label class="block text-sm font-medium">–¢–∏–ø –∑–∞—è–≤–∫–∏</label>
    <select name="type" class="border px-2 py-1 rounded">
      <option value="">–í—Å–µ</option>
      <option value="manual" {% if request.args.get('type') == 'manual' %}selected{% endif %}>–†—É—á–Ω—ã–µ</option>
      <option value="auto" {% if request.args.get('type') == 'auto' %}selected{% endif %}>–ê–≤—Ç–æ</option>
      <option value="admin_action" {% if request.args.get('type') == 'admin_action' %}selected{% endif %}>–ê–¥–º–∏–Ω</option>
      <option value="internal_transfer" {% if request.args.get('type') == 'internal_transfer' %}selected{% endif %}>–ü–µ—Ä–µ–≤–æ–¥—ã</option>
    </select>
  </div>

  <!-- –ê–∫—Ç–∏–≤ -->
  <div>
    <label class="block text-sm font-medium">–ê–∫—Ç–∏–≤</label>
    <select name="asset" class="border px-2 py-1 rounded">
      <option value="">–í—Å–µ</option>
      {% for asset in assets %}
        <option value="{{ asset.symbol }}" {% if request.args.get('asset') == asset.symbol %}selected{% endif %}>
          {{ asset.symbol }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- –û–ø–µ—Ä–∞—Ç–æ—Ä -->
  <div>
    <label class="block text-sm font-medium">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
    <select name="operator_id" class="border px-2 py-1 rounded">
      <option value="">–í—Å–µ</option>
      {% for op in operators %}
        <option value="{{ op.id }}" {% if request.args.get('operator_id') == op.id|string %}selected{% endif %}>
          {{ op.login }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- –ü–æ–∏—Å–∫ -->
  <div>
    <label class="block text-sm font-medium">–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é</label>
    <input type="text" name="search" value="{{ request.args.get('search', '') }}"
           class="border px-2 py-1 rounded" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ -->
  <div>
    <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
  </div>
</form>

    <!-- –ó–∞—è–≤–∫–∏ -->
    <h2 class="section-title mb-4">–ó–∞—è–≤–∫–∏</h2>
<table class="min-w-full bg-white rounded-lg shadow overflow-hidden">
  <thead class="bg-gray-100 text-left text-sm font-semibold text-gray-700">
    <tr>
      <th class="p-3">ID</th>
      <th class="p-3">–¢–∏–ø</th>
      <th class="p-3">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
      <th class="p-3">–ü–æ–ª—É—á–∏–ª–∏</th>
      <th class="p-3">–û—Ç–¥–∞–ª–∏</th>
      <th class="p-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
      <th class="p-3">–ü—Ä–∏–±—ã–ª—å (%)</th>
    </tr>
  </thead>
  <tbody class="text-sm divide-y divide-gray-200">
    {% for o in orders %}
    <tr>
      <!-- ID -->
      <td class="p-3 font-mono text-gray-600">{{ o.id }}</td>

      <!-- –¢–∏–ø –∑–∞—è–≤–∫–∏ -->
      <td class="p-3">
        {% if o.type == "admin_action" %}
          <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">–ê–¥–º–∏–Ω</span>
        {% elif o.type == "internal_transfer" %}
          <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">–ü–µ—Ä–µ–≤–æ–¥</span>
        {% else %}
          <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">–ó–∞—è–≤–∫–∞</span>
        {% endif %}
      </td>

      <!-- –û–ø–µ—Ä–∞—Ç–æ—Ä -->
      <td class="p-3 flex items-center gap-2">
        <div class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 text-xs font-bold">
          {{ o.user.login[0]|upper if o.user else "?" }}
        </div>
        <span>{{ o.user.login if o.user else "-" }}</span>
      </td>

      <!-- –ü–æ–ª—É—á–∏–ª–∏ -->
      <td class="p-3 font-medium text-green-600">
        {{ o.received_amount }} {{ o.received_asset.symbol if o.received_asset else "" }}
      </td>

      <!-- –û—Ç–¥–∞–ª–∏ -->
      <td class="p-3 font-medium text-red-600">
        {{ o.given_amount }} {{ o.given_asset.symbol if o.given_asset else "" }}
      </td>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <td class="p-3 text-gray-600">{{ o.comment }}</td>

      <!-- –ü—Ä–∏–±—ã–ª—å -->
      <td class="p-3">
        {% if o.profit_percent > 0 %}
          <span class="text-green-600 font-semibold">+{{ "%.2f"|format(o.profit_percent) }}%</span>
        {% elif o.profit_percent < 0 %}
          <span class="text-red-600 font-semibold">{{ "%.2f"|format(o.profit_percent) }}%</span>
        {% else %}
          <span class="text-gray-400">0%</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination">
      {% if page > 1 %}
        <a href="{{ url_for('index', page=page-1) }}" class="page-btn">‚¨Ö –ù–∞–∑–∞–¥</a>
      {% endif %}
      <span class="page-current">–°—Ç—Ä. {{ page }}</span>
      {% if has_next %}
        <a href="{{ url_for('index', page=page+1) }}" class="page-btn">–í–ø–µ—Ä—ë–¥ ‚û°</a>
      {% endif %}
    </div>

    <!-- –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò -->
<h2 class="section-title mt-8">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
<form action="{{ url_for('add_order') }}" method="post" class="bg-white p-4 rounded shadow space-y-3">
  <input type="hidden" name="service_id" value="{{ service.id }}">
  <input type="hidden" name="user_id" value="1"> <!-- –ø–æ–∫–∞ –∂—ë—Å—Ç–∫–æ —Å—Ç–∞–≤–∏–º operator1 -->

  <div>
  <label class="block text-sm font-medium">–ü–æ–ª—É—á–∏–ª–∏</label>
  <select name="received_asset_id" class="border px-2 py-1 rounded">
    {% for asset in assets %}
      <option value="{{ asset.id }}">{{ asset.symbol }}</option>
    {% endfor %}
  </select>
  <input type="text" name="received_amount" placeholder="–°—É–º–º–∞" class="border px-2 py-1 rounded">
</div>

<div>
  <label class="block text-sm font-medium">–û—Ç–¥–∞–ª–∏</label>
  <select name="given_asset_id" class="border px-2 py-1 rounded">
    {% for asset in assets %}
      <option value="{{ asset.id }}">{{ asset.symbol }}</option>
    {% endfor %}
  </select>
  <input type="text" name="given_amount" placeholder="–°—É–º–º–∞" class="border px-2 py-1 rounded">
</div>

  <div>
    <label class="block text-sm font-medium">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="border w-full px-2 py-1 rounded">
  </div>

  <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>


  </div>
</body>
</html>
