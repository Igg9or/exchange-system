<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Crypto Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<header class="bg-white shadow p-4 mb-4 flex justify-between items-center">
  <div>
    <span class="font-semibold">–ü—Ä–∏–≤–µ—Ç, {{ user.login }}</span>
    <span class="text-gray-500 text-sm"> ({{ user.role }})</span>
  </div>
  <div class="flex items-center gap-3">
    {% if user.role == "admin" %}
      <a href="{{ url_for('users_list') }}" class="bg-blue-500 text-white px-3 py-1 rounded">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    {% endif %}
    <a href="{{ url_for('logout') }}" class="bg-red-500 text-white px-3 py-1 rounded">–í—ã–π—Ç–∏</a>
  </div>
</header>

<div class="container mx-auto px-4">

  <!-- –ë–∞–ª–∞–Ω—Å—ã -->
  <div class="grid grid-cols-3 md:grid-cols-5 gap-3 mb-4">
    {% for balance, asset in balances %}
      <div class="bg-white p-3 rounded shadow flex flex-col items-center">
        <div class="text-2xl font-bold">
          {% if asset.symbol == "BTC" %} ‚Çø
          {% elif asset.symbol == "USDT" %} üíµ
          {% elif asset.symbol == "RUB" %} ‚ÇΩ
          {% else %} üîπ
          {% endif %}
        </div>
        <div class="font-semibold">{{ asset.symbol }}</div>
        <div class="text-gray-600 text-sm">{{ "%.4f"|format(balance.amount) }}</div>
      </div>
    {% endfor %}
  </div>

  <!-- –ü–∞–Ω–µ–ª—å —Å–º–µ–Ω -->
<div class="bg-white p-4 rounded shadow flex flex-col gap-3 mb-4">
  <div class="flex justify-between items-center">
    <div>
      {% if current_shift %}
        <p><b>–ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞:</b> {{ current_shift.number }}</p>
        <p><b>–ó–∞–ø—É—Å—Ç–∏–ª:</b> {{ current_shift.user.login if current_shift.user else '-' }}</p>
        <p><b>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</b> {{ current_shift.start_time }}</p>
      {% else %}
        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã</p>
      {% endif %}
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–º–µ–Ω -->
  <div class="flex gap-6">
    {% for i in range(1,4) %}
      <form action="{{ url_for('set_shift') }}" method="post"
            onsubmit="return confirm('–ó–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É –∏ –æ—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É {{ i }}?')">
        <input type="hidden" name="shift_number" value="{{ i }}">
        <button type="submit"
          class="px-3 py-1 rounded {{ 'bg-green-500 text-white' if current_shift and current_shift.number == i else 'bg-gray-200' }}">
          –°–º–µ–Ω–∞ {{ i }}
        </button>
      </form>
    {% endfor %}
  </div>
</div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="bg-white p-3 rounded shadow flex justify-between items-center mb-4">
    <form method="get" class="flex gap-3">
      <select name="type" class="border px-2 py-1 rounded">
        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
        <option value="internal_transfer" {% if request.args.get('type') == 'internal_transfer' %}selected{% endif %}>–ü–µ—Ä–µ–≤–æ–¥</option>
        <option value="admin_action" {% if request.args.get('type') == 'admin_action' %}selected{% endif %}>–ê–¥–º–∏–Ω</option>
      </select>
      <select name="asset_id" class="border px-2 py-1 rounded">
        <option value="">–í—Å–µ –∞–∫—Ç–∏–≤—ã</option>
        {% for asset in assets %}
          <option value="{{ asset.id }}" {% if request.args.get('asset_id') == asset.id|string %}selected{% endif %}>{{ asset.symbol }}</option>
        {% endfor %}
      </select>
      <select name="operator_id" class="border px-2 py-1 rounded">
        <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
        {% for u in all_users %}
          <option value="{{ u.id }}" {% if request.args.get('operator_id') == u.id|string %}selected{% endif %}>{{ u.login }}</option>
        {% endfor %}
      </select>
      <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." value="{{ request.args.get('comment','') }}"
             class="border px-2 py-1 rounded">
      <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </form>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
    <button onclick="document.getElementById('transferModal').classList.remove('hidden')"
      class="bg-green-600 text-white px-3 py-1 rounded">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ -->
  <div class="bg-white p-3 rounded shadow">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="bg-gray-100">
          <th class="p-2 border">ID</th>
          <th class="p-2 border">–¢–∏–ø</th>
          <th class="p-2 border">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
          <th class="p-2 border">–ü–æ–ª—É—á–∏–ª–∏</th>
          <th class="p-2 border">–û—Ç–¥–∞–ª–∏</th>
          <th class="p-2 border">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th class="p-2 border">–ü—Ä–∏–±—ã–ª—å (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
          <tr>
            <td class="p-2 border">{{ o.id }}</td>
            <td class="p-2 border">
              {% if o.type == 'admin_action' %}
                <span class="bg-yellow-200 px-2 py-0.5 rounded text-xs">–ê–¥–º–∏–Ω</span>
              {% elif o.type == 'internal_transfer' %}
                <span class="bg-blue-200 px-2 py-0.5 rounded text-xs">–ü–µ—Ä–µ–≤–æ–¥</span>
              {% else %}
                <span class="bg-green-200 px-2 py-0.5 rounded text-xs">–ó–∞—è–≤–∫–∞</span>
              {% endif %}
            </td>
            <td class="p-2 border">{{ o.user.login if o.user else '-' }}</td>
            <td class="p-2 border text-green-600">{{ o.received_amount }}</td>
            <td class="p-2 border text-red-600">{{ o.given_amount }}</td>
            <td class="p-2 border">{{ o.comment }}</td>
            <td class="p-2 border">{{ "%.2f"|format(o.profit_percent or 0) }} %</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
<div id="transferModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-3">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏</h2>
    <form action="{{ url_for('internal_transfer') }}" method="post" class="space-y-3">
      <div>
        <label class="block text-sm">–û—Ç–∫—É–¥–∞</label>
        <select name="from_service_id" class="border w-full px-2 py-1 rounded">
          {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm">–ö—É–¥–∞</label>
        <select name="to_service_id" class="border w-full px-2 py-1 rounded">
          {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm">–ê–∫—Ç–∏–≤</label>
        <select name="asset_id" class="border w-full px-2 py-1 rounded">
          {% for asset in assets %}
            <option value="{{ asset.id }}">{{ asset.symbol }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm">–°—É–º–º–∞</label>
        <input type="number" step="0.0001" name="amount" class="border w-full px-2 py-1 rounded">
      </div>
      <div>
        <label class="block text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="document.getElementById('transferModal').classList.add('hidden')"
                class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>
