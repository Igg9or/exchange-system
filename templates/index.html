  <!DOCTYPE html>
  <html lang="ru">
  <head>
    <meta charset="UTF-8">
    <title>Crypto Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-900">

  <header class="bg-white shadow p-4 mb-4 flex justify-between items-center">
    <div>
      <span class="font-semibold">–ü—Ä–∏–≤–µ—Ç, {{ user.login }}</span>
      <span class="text-gray-500 text-sm"> ({{ user.role }})</span>
    </div>
    <div class="flex items-center gap-3">
    {% if user.role == "admin" %}
      <a href="{{ url_for('users_list') }}" class="bg-blue-500 text-white px-3 py-1 rounded">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <form method="get" class="inline">
        <select name="service_id" onchange="this.form.submit()" class="border px-2 py-1 rounded">
          <option value="">–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã</option>
          {% for s in services %}
            <option value="{{ s.id }}" {% if selected_service_id == s.id %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
      </form>
    {% endif %}

    <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –∞–¥–º–∏–Ω—É, –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É -->
    <button type="button"
            onclick="document.getElementById('adminIOModal').classList.remove('hidden')"
            class="bg-purple-600 text-white px-3 py-1 rounded">üí∞ –í–Ω–µ—Å—Ç–∏/–í—ã–≤–µ—Å—Ç–∏</button>
            <button type="button"
        onclick="document.getElementById('addAssetModal').classList.remove('hidden')"
        class="bg-indigo-600 text-white px-3 py-1 rounded">
  ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤
</button>

    <a href="{{ url_for('logout') }}" class="bg-red-500 text-white px-3 py-1 rounded">–í—ã–π—Ç–∏</a>
  </div>
  </header>

  <div class="container mx-auto px-4">

    <!-- –ë–∞–ª–∞–Ω—Å—ã -->
   <div id="balances" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 mb-4">
  {% for balance, asset in balances %}
    {% if asset.id in top_assets %}
      <div class="bg-white p-2 rounded shadow flex flex-col items-center text-xs">
        <div class="text-lg">
          {% if asset.symbol == "BTC" %} ‚Çø
          {% elif "USDT" in asset.symbol %} üíµ
          {% elif asset.symbol == "RUB" %} ‚ÇΩ
          {% else %} üîπ
          {% endif %}
        </div>
        <div class="font-medium text-[10px] text-center truncate w-full">{{ asset.symbol }}</div>
        <div class="text-gray-600 text-[10px]">{{ "%.2f"|format(balance.amount) }}</div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<!-- —Å–∫—Ä—ã—Ç—ã–µ –∞–∫—Ç–∏–≤—ã -->
<div id="more-balances" class="hidden grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 mb-4">
  {% for balance, asset in balances %}
    {% if asset.id not in top_assets %}
      <div class="bg-white p-2 rounded shadow flex flex-col items-center text-xs">
        <div class="text-lg">
          {% if asset.symbol == "BTC" %} ‚Çø
          {% elif "USDT" in asset.symbol %} üíµ
          {% elif asset.symbol == "RUB" %} ‚ÇΩ
          {% else %} üîπ
          {% endif %}
        </div>
        <div class="font-medium text-[10px] text-center truncate w-full">{{ asset.symbol }}</div>
        <div class="text-gray-600 text-[10px]">{{ "%.2f"|format(balance.amount) }}</div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<!-- –∫–Ω–æ–ø–∫–∞ -->
<button onclick="document.getElementById('more-balances').classList.toggle('hidden')"
        class="bg-gray-200 px-3 py-1 rounded text-sm">
  –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å / –°–∫—Ä—ã—Ç—å
</button>

    <!-- –ü–∞–Ω–µ–ª—å —Å–º–µ–Ω -->
  <div class="flex justify-between items-center">
    <div>
      {% if current_shift %}
        <p><b>–ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞:</b> {{ current_shift.number }}</p>
        <p><b>–ó–∞–ø—É—Å—Ç–∏–ª:</b> {{ current_shift.user.login if current_shift.user else '-' }}</p>
        <p><b>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</b> {{ current_shift.start_time }}</p>
      {% else %}
        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã</p>
      {% endif %}
    </div>

    <!-- üî• –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–±—ã–ª–∏ -->
    <div class="text-right">
      {% if current_shift %}
        <p class="font-semibold text-green-600">–ü—Ä–∏–±—ã–ª—å —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã: {{ "%.2f"|format(current_profit) }} ‚ÇΩ</p>
        <p class="text-gray-600 text-sm">–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å–º–µ–Ω–∞: {{ "%.2f"|format(prev_profit) }} ‚ÇΩ</p>
      {% endif %}
    </div>
  </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–º–µ–Ω -->
    <div class="flex gap-6">
      {% for i in range(1,4) %}
        <form action="{{ url_for('set_shift') }}" method="post" class="shift-form">
          <input type="hidden" name="shift_number" value="{{ i }}">
          <button type="button"
            onclick="openShiftModal({{ i }}, this.form)"
            class="px-3 py-1 rounded {{ 'bg-green-500 text-white' if current_shift and current_shift.number == i else 'bg-gray-200' }}">
            –°–º–µ–Ω–∞ {{ i }}
          </button>
        </form>
      {% endfor %}
    </div>
  </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-white p-3 rounded shadow flex justify-between items-center mb-4">
      <form method="get" class="flex gap-3">
        <select name="type" class="border px-2 py-1 rounded">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="internal_transfer" {% if request.args.get('type') == 'internal_transfer' %}selected{% endif %}>–ü–µ—Ä–µ–≤–æ–¥</option>
          <option value="admin_action" {% if request.args.get('type') == 'admin_action' %}selected{% endif %}>–ê–¥–º–∏–Ω</option>
        </select>
        <select name="asset_id" class="border px-2 py-1 rounded">
          <option value="">–í—Å–µ –∞–∫—Ç–∏–≤—ã</option>
          {% for asset in assets %}
            <option value="{{ asset.id }}" {% if request.args.get('asset_id') == asset.id|string %}selected{% endif %}>{{ asset.symbol }}</option>
          {% endfor %}
        </select>
        <select name="operator_id" class="border px-2 py-1 rounded">
          <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
          {% for u in all_users %}
            <option value="{{ u.id }}" {% if request.args.get('operator_id') == u.id|string %}selected{% endif %}>{{ u.login }}</option>
          {% endfor %}
        </select>
        <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." value="{{ request.args.get('comment','') }}"
              class="border px-2 py  -1 rounded">
        <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
      </form>

      <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
      <button onclick="document.getElementById('transferModal').classList.remove('hidden')"
        class="bg-green-600 text-white px-3 py-1 rounded">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏</button>

        {% if user.role == "operator" %}
    <button onclick="document.getElementById('orderModal').classList.remove('hidden')"
      class="bg-blue-600 text-white px-3 py-1 rounded">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
  {% endif %}
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ -->
    <div class="bg-white p-3 rounded shadow">
    <table class="w-full text-sm border-collapse">
      <thead>
    <tr class="bg-gray-100">
      <th class="p-2 border">ID</th>
      <th class="p-2 border">–í—Ä–µ–º—è</th> <!-- ‚úÖ –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <th class="p-2 border">–¢–∏–ø</th>
      <th class="p-2 border">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
      <th class="p-2 border">–ü–æ–ª—É—á–∏–ª–∏</th>
      <th class="p-2 border">–û—Ç–¥–∞–ª–∏</th>
      <th class="p-2 border">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
      <th class="p-2 border">–ü—Ä–∏–±—ã–ª—å (%)</th>
      <th class="p-2 border">–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)</th>

    </tr>
  </thead>
  <tbody>
    {% for o in orders %}
      <tr>
        <td class="p-2 border">{{ o.id }}</td>
        <td class="p-2 border">
    {{ o.created_at.strftime("%d.%m.%Y %H:%M") if o.created_at else "-" }}
  </td>
        <td class="p-2 border">
          {% if o.type == 'admin_action' %}
            <span class="bg-yellow-200 px-2 py-0.5 rounded text-xs">–ê–¥–º–∏–Ω</span>
          {% elif o.type == 'internal_transfer' %}
            <span class="bg-blue-200 px-2 py-0.5 rounded text-xs">–ü–µ—Ä–µ–≤–æ–¥</span>
          {% else %}
            <span class="bg-green-200 px-2 py-0.5 rounded text-xs">–ó–∞—è–≤–∫–∞</span>
          {% endif %}
        </td>
        <td class="p-2 border">{{ o.user.login if o.user else '-' }}</td>
        <td class="p-2 border text-green-600">
          {{ o.received_amount }} {{ o.received_asset.symbol if o.received_asset else '' }}
        </td>
        <td class="p-2 border text-red-600">
          {{ o.given_amount }} {{ o.given_asset.symbol if o.given_asset else '' }}
        </td>
        <td class="p-2 border">{{ o.comment }}</td>
        <td class="p-2 border">{{ "%.2f"|format(o.profit_percent or 0) }} %</td>
        <td class="p-2 border">{{ "%.2f"|format(o.profit_rub or 0) }} ‚ÇΩ</td>
      </tr>
    {% endfor %}
  </tbody>
    </table>


  </div>

  {% set args = request.args.to_dict(flat=True) %}
  {% set _ = args.pop('page', None) %}

  <!-- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <div class="pagination mt-4">
    {% if page > 1 %}
      <a href="{{ url_for('index', page=page-1, **args) }}" class="page-btn">¬´ –ù–∞–∑–∞–¥</a>
    {% endif %}

    <span class="page-current">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}</span>

    {% if page < total_pages %}
      <a href="{{ url_for('index', page=page+1, **args) }}" class="page-btn">–í–ø–µ—Ä—ë–¥ ¬ª</a>
    {% endif %}
  </div>

  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
  <div id="transferModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-3">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏</h2>
      <form action="{{ url_for('internal_transfer') }}" method="post" class="space-y-3">
        <div>
          <label class="block text-sm">–û—Ç–∫—É–¥–∞</label>
          <select name="from_service_id" class="border w-full px-2 py-1 rounded">
            {% for s in services %}
              <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–ö—É–¥–∞</label>
          <select name="to_service_id" class="border w-full px-2 py-1 rounded">
            {% for s in services %}
              <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–ê–∫—Ç–∏–≤</label>
          <select name="asset_id" class="border w-full px-2 py-1 rounded">
            {% for asset in assets %}
              <option value="{{ asset.id }}">{{ asset.symbol }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–°—É–º–º–∞</label>
          <input type="number" step="0.0001" name="amount" class="border w-full px-2 py-1 rounded">
        </div>
        <div>
          <label class="block text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="document.getElementById('transferModal').classList.add('hidden')"
                  class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É -->
  <div id="orderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-3">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h2>
      <form action="{{ url_for('add_order') }}" method="post" class="space-y-3">
        
        <!-- –ü–æ–ª—É—á–∞–µ–º -->
        <div>
          <label class="block text-sm">–ü–æ–ª—É—á–∞–µ–º (–ê–∫—Ç–∏–≤)</label>
          <select name="received_asset_id" class="border w-full px-2 py-1 rounded">
            {% for asset in assets %}
              <option value="{{ asset.id }}">{{ asset.symbol }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–°—É–º–º–∞ –ø–æ–ª—É—á–∞–µ–º</label>
          <input type="number" step="0.0001" name="received_amount" class="border w-full px-2 py-1 rounded" required>
        </div>

        <!-- –û—Ç–¥–∞—ë–º -->
        <div>
          <label class="block text-sm">–û—Ç–¥–∞—ë–º (–ê–∫—Ç–∏–≤)</label>
          <select name="given_asset_id" class="border w-full px-2 py-1 rounded">
            {% for asset in assets %}
              <option value="{{ asset.id }}">{{ asset.symbol }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–°—É–º–º–∞ –æ—Ç–¥–∞—ë–º</label>
          <input type="number" step="0.0001" name="given_amount" class="border w-full px-2 py-1 rounded" required>
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
        <div>
          <label class="block text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex justify-end gap-2">
          <button type="button" onclick="document.getElementById('orderModal').classList.add('hidden')"
                  class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <div id="adminIOModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-3">–ê–¥–º–∏–Ω: –í–Ω–µ—Å—Ç–∏ / –í—ã–≤–µ—Å—Ç–∏ –∞–∫—Ç–∏–≤</h2>
      <form action="{{ url_for('admin_io') }}" method="post" class="space-y-3">
        <div>
          <label class="block text-sm">–°–µ—Ä–≤–∏—Å</label>
          <select name="service_id" class="border w-full px-2 py-1 rounded">
            {% for s in services %}
              <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–ê–∫—Ç–∏–≤</label>
          <select name="asset_id" class="border w-full px-2 py-1 rounded">
            {% for asset in assets %}
              <option value="{{ asset.id }}">{{ asset.symbol }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
          <select name="direction" class="border w-full px-2 py-1 rounded">
            <option value="in">–í–Ω–µ—Å—Ç–∏</option>
            <option value="out">–í—ã–≤–µ—Å—Ç–∏</option>
          </select>
        </div>
        <div>
          <label class="block text-sm">–°—É–º–º–∞</label>
          <input type="number" step="0.0001" name="amount" required class="border w-full px-2 py-1 rounded">
        </div>
        <div>
          <label class="block text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" name="comment" class="border w-full px-2 py-1 rounded">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="document.getElementById('adminIOModal').classList.add('hidden')"
                  class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="bg-purple-600 text-white px-3 py-1 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

<div id="shiftConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-3">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã</h2>
    <p id="shiftModalText" class="mb-4 text-gray-700">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="flex justify-end gap-2">
      <button type="button" onclick="closeShiftModal()"
              class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
      <button id="shiftConfirmBtn" type="button"
              class="bg-red-600 text-white px-3 py-1 rounded">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="addAssetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤</h2>
    <form action="{{ url_for('add_asset') }}" method="post" class="space-y-3">
      <div>
        <label class="block text-sm">–°–µ—Ä–≤–∏—Å</label>
        <select name="service_id" class="border w-full px-2 py-1 rounded" required>
          {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm">–°–∏–º–≤–æ–ª</label>
        <input type="text" name="symbol" class="border w-full px-2 py-1 rounded" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: USDT TRC-20">
      </div>
      <div>
        <label class="block text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" name="name" class="border w-full px-2 py-1 rounded" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Tether TRC-20">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="document.getElementById('addAssetModal').classList.add('hidden')"
                class="bg-gray-300 px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>



<script>
let targetForm = null;

function openShiftModal(shiftNumber, form) {
  targetForm = form;
  document.getElementById('shiftModalText').innerText =
    `‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É –∏ –æ—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ${shiftNumber}?`;
  document.getElementById('shiftConfirmModal').classList.remove('hidden');
}

function closeShiftModal() {
  document.getElementById('shiftConfirmModal').classList.add('hidden');
  targetForm = null;
}

document.getElementById('shiftConfirmBtn').addEventListener('click', () => {
  if (targetForm) {
    targetForm.submit();
  }
});
</script>

  </body>
  </html>
